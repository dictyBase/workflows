name: deploy backend dcr application
on:
  workflow_call:
    inputs:
        deploy_group:
          type: string
          description: deploy group either of backend or frontend
          default: backend
        run_id:
          type: string
          required: true
          description: github workflow runner id
        dagger_version:
          required: true
          type: string
          description: "version of the Dagger binary"
        dagger_checksum:
          required: true
          type: string
          description: "checksum of the Dagger binary"
        dagger_path:
          type: string
          description: path where dagger binary will be kept
          default: /tmp/dag/bin
    #   repository:
    #     required: true
    #     type: string
    #     description: "Repository name with owner"
    #   image:
    #     required: true
    #     type: string 
    #     description: "Name of docker image"
    #   ref:
    #     required: true
    #     type: string
    #     description: "The branch,tag or SHA to checkout"
    #   dockerfile:
    #     required: true
    #     type: string
    #     description: "location of the docker file"
    #   namespace:
    #     required: false
    #     type: string
    #     default: "dictybase"
    #     description: "namespace to use for docker image"
    #   cluster:
    #     required: true
    #     type: string
    #     description: "name of kubernetes cluster"
    #   cluster_state_storage:
    #     required: true
    #     type: string
    #     description: "location of cluster state"
    #   pulumi_state_storage:
    #     type: string
    #     description: "location of pulumi state"
    #     default: "gs://dictycr-pulumi-state"

env:
  DAGGER_BIN_PATH: /tmp/dag/bin
  KUBECONFIG_FOLDER: /tmp/config
  KUBECONFIG: /tmp/config/dictycr.yaml
  PULUMI_MODULE: github.com/dictybase-docker/dagger-of-dcr/pulumi-ops@main

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: manage paths
        run: |
          mkdir -p $DAGGER_BIN_PATH 
          echo $DAGGER_BIN_PATH >> $GITHUB_PATH

      # - name: setup dagger version and checksum
      #   id: dag_check
      #   run: actions sc
      #
      # - name: try to restore dagger binary cache with dagger version and checksum
      #   id: restore_dagger_bin_cache
      #   uses: actions/cache@v4
      #   with: 
      #     path: ${{ env.DAGGER_BIN_PATH }}
      #     key: ${{ runner.os }}-${{ steps.dag_check.outputs.dagger_version}}-${{ steps.dag_check.outputs.dagger_bin_checksum }}

      - name: download kubectl
        uses: actions/download-artifact@v4
        with: 
          name: kubectl-config
          path: ${{ env.KUBECONFIG_FOLDER }}
          run-id: ${{ inputs.run_id }}

      - name: verify kubectl
        run: kubectl get nodes

      # - name: verify pulumi
      #   run: dagger call -m $PULUMI_MODULE with-backend --backend ${{ inputs.pulumi_state_storage }} with-credentials --credentials=${{ steps.gcp_authentication.outputs.credentials_file_path }} with-pulumi login
